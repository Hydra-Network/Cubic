---
import Layout from "@/Layout.astro";
import { Icon } from "astro-icon/components";
import gmesData from "@/gmes.json";
import GameCard from "@/components/GameCard.astro";

const popularGames = [
  "Hollow Knight",
  "ULTRAKILL",
  "Celeste",
  "Katana ZERO",
  "Dead Cells",
  "Hyper Light Drifter",
  "DOOM",
  "Doom 64",
  "Castlevania",
  "Castlevania Aria of Sorrow",
  "Super Meat Boy",
  "Cuphead",
  "Among Us",
  "Cookie Clicker",
  "Baldis Basics",
  "Buckshot Roulette",
  "A Dark Room",
  "Binding of Isaac",
  "Undertale",
  "Deltarune",
  "Celeste 2",
  "Alien Hominid",
  "Chaos Faction 2",
  "Bloons TD 5",
  "Age of War",
  "Duck Life",
  "Burrito Bison",
  "Happy Wheels",
  "Cluster Rush",
  "Drive Mad",
];

const allGmes = [...gmesData].sort((a, b) => {
  const aIsPopular = popularGames.includes(a.title);
  const bIsPopular = popularGames.includes(b.title);
  
  if (aIsPopular && !bIsPopular) return -1;
  if (!aIsPopular && bIsPopular) return 1;
  if (aIsPopular && bIsPopular) {
    return popularGames.indexOf(a.title) - popularGames.indexOf(b.title);
  }
  
  return a.title.localeCompare(b.title, undefined, { sensitivity: "base" });
});
---

<Layout>
  <div
    class="sticky top-0 z-50 flex justify-center py-3 shadow-md backdrop-blur"
  >
    <div
      class="bg-slate-800 flex w-full max-w-xl items-center rounded-md px-3 shadow"
    >
      <Icon name="lucide:search" class="text-slate-400 size-5" />
      <input
        id="search_games"
        type="text"
        class="w-full flex-1 bg-transparent py-2 pl-3 focus:outline-none"
        placeholder={`Search from ${gmesData.length} games`}
      />
    </div>
  </div>

  <section id="gmes" class="flex flex-wrap justify-center gap-6 p-6 max-w-[1400px] mx-auto">
    {allGmes.map((gme) => <GameCard {...gme} />)}
  </section>

  <div
    id="gme"
    class="bg-slate-800/90 fixed top-0 right-0 bottom-0 left-0 z-[999] hidden"
  >
    <h2
      id="title"
      class="absolute top-[15px] left-[20px] z-50 text-3xl font-bold"
    >
    </h2>

    <button
      id="back"
      class="bg-slate-700/70 hover:bg-slate-800/70 absolute top-[15px] right-[20px] z-50 flex cursor-pointer items-center rounded-lg border-0 px-4 py-2 transition"
    >
      <Icon name="lucide:x" class="size-5" />
      Close
    </button>
  </div>

  <script>
    const search = document.getElementById("search_games");
    const gmes = document.getElementById("gmes");
    const cards = Array.from(gmes.querySelectorAll(".game-card"));

    search.addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase();
      cards.forEach((card) => {
        const match = card.getAttribute("data-title").toLowerCase().includes(q);
        card.style.display = match ? "inline-block" : "none";
      });
    });

    gmes.addEventListener("click", (e) => {
      const card = e.target.closest(".game-card");
      if (!card) return;
      const fn = card.dataset.file;
      const t = card.dataset.title;
      if (fn && t) window.opengme(fn, t, card.dataset.frame);
    });

    gmes.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      const card = e.target.closest(".game-card");
      if (!card) return;
      e.preventDefault();
      const fn = card.dataset.file;
      const t = card.dataset.title;
      if (fn && t) window.opengme(fn, t, card.dataset.frame);
    });

    function hideFrames() {
      document.getElementById("gme").querySelectorAll("iframe").forEach(f => {
        f.src = "about:blank";
        f.remove();
      });
    }

    window.opengme = async (file_name, title, frameGme) => {
      hideFrames();
      const container = document.getElementById("gme");
      const frame = document.createElement("iframe");
      frame.title = "game";

      document.getElementById("title").textContent = title;
      container.classList.remove("hidden");
      document.body.style.overflow = "hidden";

      let originalSrc;
      if (frameGme == "true") {
        originalSrc = `https://raw.githack.com/hydra-network/asseting-bromine/main/${file_name}`;
        frame.src = originalSrc;
      } else {
        originalSrc = "/blank.html";
        frame.onload = async function() {
          if (this.dataset.loaded) return;
          const doc = this.contentDocument;
          const html = await fetch(
            `https://cdn.jsdelivr.net/gh/hydra-network/asseting-bromine@main/${file_name}`
          ).then(r => r.text());

          doc.open();
          doc.write(html);
          doc.close();
          doc.querySelectorAll("script").forEach((s) => {
            const ns = doc.createElement("script");
            ns.src = s.src || "";
            if (!s.src) ns.textContent = s.textContent;
            s.replaceWith(ns);
          });
          this.dataset.loaded = "1";
        };
        frame.src = originalSrc;
      }
      container.append(frame);
    };

    window.closegme = () => {
      hideFrames();
      document.getElementById("gme").classList.add("hidden");
      document.body.style.overflow = "";
    };

    document.getElementById("back").addEventListener("click", closegme);
  </script>
</Layout>
