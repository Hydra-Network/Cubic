---
import Layout from "@/Layout.astro";
import { ArrowLeft, ArrowRight, X, Minus } from "@lucide/astro";
import GameCard from "@/components/GameCard.astro";

let gamesData = [];

try {
  const response = await fetch('https://cdn.jsdelivr.net/gh/Hydra-Network/hydra-assets@main/gmes.json');
  if (response.ok) {
    gamesData = await response.json();
  }
} catch (error) {
  console.error("Failed to fetch games:", error);
}

const allGames = [...gamesData].sort((a, b) => {
  const aIsPopular = popularGames.includes(a.title);
  const bIsPopular = popularGames.includes(b.title);

  if (aIsPopular && !bIsPopular) return -1;
  if (!aIsPopular && bIsPopular) return 1;
  if (aIsPopular && bIsPopular) {
    return popularGames.indexOf(a.title) - popularGames.indexOf(b.title);
  }
  return a.title.localeCompare(b.title, undefined, { sensitivity: "base" });
});

---

<Layout>
  <!-- navbar -->
  <nav
    class="sticky top-0 z-20 flex justify-center py-3 bg-gradient-to-b from-deep to-transparent backdrop-blur-xl"
  >
    <div
      class="flex w-full max-w-xl items-center pl-3 pr-0 gap-3 bg-card border border-subtle shadow-[0_4px_24px_rgba(0,0,0,0.4)]"
    >
      <img src="/logo.webp" alt="Cubic Logo" class="h-8 w-auto flex-shrink-0" />
      <input
        id="search_games"
        type="text"
        class="w-full flex-1 py-2 text-center text-sm transition-all duration-200 bg-deep border border-subtle text-primary"
        placeholder={`Search from ${gamesData.length} games`}
      />
    </div>
  </nav>

  <!-- games -->
  <section
    id="games"
    class="flex flex-wrap justify-center gap-6 p-6 max-w-[1400px] mx-auto"
  >
    {
      allGames.map((game, index) => (
        <div class={`game-item ${index >= 20 ? "hidden opacity-0" : "opacity-100"} transition-opacity duration-500`}>
          <GameCard {...game} />
        </div>
      ))
    }
  </section>

  <div
    id="load-more-trigger"
    class="w-full flex flex-col items-center justify-center py-20"
  >
    <div class="flex items-center gap-2 mb-6">
      <div class="loading-dot h-2.5 w-2.5 rounded-full bg-muted animate-bounce"></div>
      <div class="loading-dot h-2.5 w-2.5 rounded-full bg-muted animate-bounce"></div>
      <div class="loading-dot h-2.5 w-2.5 rounded-full bg-muted animate-bounce"></div>
    </div>
    <p class="text-sm text-muted font-medium">Loading more games...</p>
  </div>

  <script>
    // Vanilla JS Intersection Observer
    const trigger = document.getElementById("load-more-trigger");
    const hiddenItems = document.querySelectorAll(".game-item.hidden");
    let currentIndex = 0;

    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        const batch = Array.from(hiddenItems).slice(
          currentIndex,
          currentIndex + 20
        );

        batch.forEach((item, index) => {
          setTimeout(() => {
            item.classList.remove("hidden");
            requestAnimationFrame(() => {
              item.classList.remove("opacity-0");
              item.classList.add("opacity-100");
            });
          }, index * 30);
        });

        currentIndex += 20;

        if (currentIndex >= hiddenItems.length) {
          observer.disconnect();
          trigger.classList.add("hidden");
        }
      }
    });

    observer.observe(trigger);
  </script>

  <!-- play -->
  <div
    id="game"
    class="fixed top-0 right-0 bottom-0 left-0 z-[999] hidden bg-deep-darker/95"
  >
    <h2
      id="title"
      class="absolute top-[15px] left-[20px] z-50 text-3xl font-bold text-primary"
    >
    </h2>

    <button
      id="closeGame"
      class="absolute top-[15px] right-[20px] z-50 flex cursor-pointer items-center px-4 py-2 transition-all duration-200 gap-1 bg-elevated border border-subtle text-primary"
    >
      <X class="size-5" />
    </button>

    <button
      id="minimizeGame"
      class="absolute top-[15px] right-[80px] z-50 flex cursor-pointer items-center px-4 py-2 transition-all duration-200 gap-1 bg-elevated border border-subtle text-primary"
    >
      <Minus class="size-5" />
    </button>
  </div>

  <script src="@/games.js"></script>
</Layout>
