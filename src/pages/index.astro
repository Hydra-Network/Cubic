---
import Layout from "@/Layout.astro";
import { Icon } from "astro-icon/components";
import gmesData from "@/gmes.json";
import GameCard from "@/components/GameCard.astro";

const allGmes = [...gmesData].sort((a, b) =>
	a.title.localeCompare(b.title, undefined, { sensitivity: "base" }),
);
---

<Layout>
	<div
		class="sticky top-0 z-50 flex justify-center py-3 shadow-md backdrop-blur"
	>
		<div
			class="bg-slate-800 flex w-full max-w-xl items-center rounded-md px-3 shadow"
		>
			<Icon name="lucide:search" class="text-slate-400 size-5" />
			<input
				id="search_games"
				type="text"
				class="w-full flex-1 bg-transparent py-2 pl-3 focus:outline-none"
				placeholder={`Search from ${gmesData.length} games`}
			/>
		</div>
	</div>

	<section id="gmes" class="flex flex-wrap justify-center gap-2.5 p-2.5">
		{allGmes.map((gme) => <GameCard {...gme} />)}
	</section>

	<div id="gme" class="bg-slate-800/90 fixed inset-0 z-[999] hidden">
		<h2
			id="title"
			class="absolute top-[15px] left-[20px] z-50 text-3xl font-bold"
		>
		</h2>

		<button
			id="back"
			class="bg-slate-700/70 hover:bg-slate-800/70 absolute top-[15px] right-[20px] z-50 flex cursor-pointer items-center rounded-lg border-0 px-4 py-2 transition"
		>
			<Icon name="lucide:x" class="size-5" />
			Close
		</button>
	</div>

	<script>
		const search = document.getElementById("search_games");
		const gmes = document.getElementById("gmes");
		const cards = Array.from(gmes.querySelectorAll(".game-card"));

		search.addEventListener("input", (event) => {
			const searchQuery = event.target.value.toLowerCase();
			cards.forEach((card) => {
				const title = card.getAttribute("data-title").toLowerCase();
				if (title.includes(searchQuery)) {
					card.style.display = "inline-block";
				} else {
					card.style.display = "none";
				}
			});
		});

		// A function to show a game by file_name
		function showGame(file_name, title) {
			const container = document.getElementById("gme");
			const titleEl = document.getElementById("title");
			const frame = document.getElementById(`game-frame-${file_name}`);

			if (!frame) return;

			titleEl.textContent = title;
			// Hide other frames
			document.querySelectorAll("#gme iframe").forEach(f => {
				if (f.id !== `game-frame-${file_name}`) {
					f.classList.add('hidden');
				}
			});

			frame.classList.remove("hidden");
			container?.classList.remove("hidden");
			document.body.style.overflow = "hidden";
			frame.focus();
		}

		window.opengme = async (file_name, title, frameGme) => {
			// If game is already in sidebar, just show it
			if (document.getElementById(`game-sidebar-${file_name}`)) {
				showGame(file_name, title);
				return;
			}
			
			const container = document.getElementById("gme");
			
			// --- Create sidebar element with close button ---
			const gameUi = document.createElement("div");
			gameUi.className = "game-sidebar-item py-3 flex items-center justify-between cursor-pointer hover:bg-slate-700 rounded-md px-2";
			gameUi.id = `game-sidebar-${file_name}`;

			const gameTitle = document.createElement('span');
			gameTitle.textContent = title;
			gameTitle.className = "truncate flex-grow";

			const closeButton = document.createElement('button');
			closeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;
			closeButton.className = 'p-1 text-slate-400 hover:text-white flex-shrink-0';
			
			closeButton.addEventListener('click', (e) => {
				e.stopPropagation();
				
				const gameFrame = document.getElementById(`game-frame-${file_name}`);
				const gameUiElement = document.getElementById(`game-sidebar-${file_name}`);

				// If game to be closed is currently active, close the main view
				if(gameFrame && !gameFrame.classList.contains('hidden')) {
					window.closegme();
				}

				gameFrame?.remove();
				gameUiElement?.remove();
			});

			gameUi.append(gameTitle);
			gameUi.append(closeButton);
			document.querySelector("aside")?.append(gameUi);

			gameUi.addEventListener("click", () => {
				showGame(file_name, title);
			});

			// --- Create iframe for the game ---
			const frame = document.createElement("iframe");
			frame.setAttribute("title", "game");
			frame.setAttribute("id", `game-frame-${file_name}`);
			// frame.className = "hidden"; // Initially hidden, showGame will unhide

			if (frameGme == "true") {
				frame.src = `https://raw.githack.com/hydra-network/asseting-bromine/main/${file_name}`;
			} else {
				frame.onload = async () => {
					if (frame.dataset.loaded) return;
					const doc = frame.contentDocument;
					if (!doc) return;
					const html = await fetch(`https://cdn.jsdelivr.net/gh/hydra-network/asseting-bromine@main/${file_name}`).then((r) => r.text());
					doc.open();
					doc.write(html);
					doc.close();
					doc.querySelectorAll("script").forEach((s) => {
						const script = doc.createElement("script");
						script.src = s.src || "";
						if (!s.src) script.textContent = s.textContent;
						s.replaceWith(script);
					});
					frame.dataset.loaded = true;
				};
				frame.src = "/asdf.html"; // Placeholder to trigger onload
			}
			container.append(frame);

			// Finally, show the newly opened game
			showGame(file_name, title);
		};

		window.closegme = () => {
			const gme = document.getElementById("gme");
			const frame = document.querySelector("#gme iframe:not(.hidden)");

			if (frame) {
				frame.classList.add("hidden");
			}
			gme.classList.add("hidden");
			document.body.style.overflow = "";
		};

		document.getElementById("back").addEventListener("click", () => {
			window.closegme();
		});
	</script>
</Layout>
