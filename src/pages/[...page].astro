---
import Layout from "@/Layout.astro";
import { ArrowLeft, ArrowRight, X } from "@lucide/astro";
import gamesData from "@/games.json";
import GameCard from "@/components/GameCard.astro";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (({ paginate }) => {
	const popularGames = [
		"Hollow Knight",
		"ULTRAKILL",
		"Celeste",
		"Katana ZERO",
		"Dead Cells",
		"Hyper Light Drifter",
		"DOOM",
		"Doom 64",
		"Castlevania",
		"Castlevania Aria of Sorrow",
		"Super Meat Boy",
		"Cuphead",
		"Among Us",
		"Cookie Clicker",
		"Baldis Basics",
		"Buckshot Roulette",
		"A Dark Room",
		"Binding of Isaac",
		"Undertale",
		"Deltarune",
		"Celeste 2",
		"Alien Hominid",
		"Chaos Faction 2",
		"Bloons TD 5",
		"Age of War",
		"Duck Life",
		"Burrito Bison",
		"Happy Wheels",
		"Cluster Rush",
		"Drive Mad",
	];

	const allGames = [...gamesData].sort((a, b) => {
		const aIsPopular = popularGames.includes(a.title);
		const bIsPopular = popularGames.includes(b.title);

		if (aIsPopular && !bIsPopular) return -1;
		if (!aIsPopular && bIsPopular) return 1;
		if (aIsPopular && bIsPopular) {
			return popularGames.indexOf(a.title) - popularGames.indexOf(b.title);
		}
		return a.title.localeCompare(b.title, undefined, { sensitivity: "base" });
	});

	return paginate(allGames, { pageSize: 20 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
---

<Layout>
	<!-- navbar -->
	<nav
		class="sticky top-0 z-20 flex justify-center py-3"
		style="background: linear-gradient(180deg, var(--bg-deep) 0%, transparent 100%); backdrop-filter: blur(16px);"
	>
		<div 
			class="flex w-full max-w-xl items-center pl-3 pr-0 gap-3"
			style="background: var(--bg-card); border: 1px solid var(--border-subtle); box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);"
		>
			<img src="/logo.webp" alt="Cubic Logo" class="h-8 w-auto flex-shrink-0" />
			<input
				id="search_games"
				type="text"
				class="w-full flex-1 py-2 text-center text-sm transition-all duration-200"
				style="background: var(--bg-deep); border: 1px solid var(--border-subtle); color: var(--text-primary);"
				placeholder={`Search from ${gamesData.length} games`}
			/>
		</div>
	</nav>

	<!-- games -->
	<section
		id="games"
		class="flex flex-wrap justify-center gap-6 p-6 max-w-[1400px] mx-auto"
	>
		{page.data.map((game) => <GameCard {...game} />)}
	</section>

	<!-- navigation -->
	<div class="flex justify-center items-center gap-6 py-10">
		{
			page.url.prev ? (
				<a
					href={page.url.prev}
					class="px-4 py-2 transition-all duration-200 flex items-center gap-2 hover:scale-105"
					style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);"
				>
					<ArrowLeft />
					Previous
				</a>
			) : (
				<div class="w-[100px]" />
			)
		}

		<span style="color: var(--text-secondary);">
			Page {page.currentPage} of {page.lastPage}
		</span>

		{
			page.url.next ? (
				<a
					href={page.url.next}
					class="px-4 py-2 transition-all duration-200 flex items-center gap-2 hover:scale-105"
					style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);"
				>
					Next <ArrowRight />
				</a>
			) : (
				<div class="w-[100px]" />
			)
		}
	</div>

	<!-- play -->
	<div
		id="game"
		class="fixed top-0 right-0 bottom-0 left-0 z-[999] hidden"
		style="background: rgba(10, 14, 23, 0.95);"
	>
		<h2
			id="title"
			class="absolute top-[15px] left-[20px] z-50 text-3xl font-bold"
			style="color: var(--text-primary);"
		>
		</h2>

		<button
			id="back"
			class="absolute top-[15px] right-[20px] z-50 flex cursor-pointer items-center px-4 py-2 transition-all duration-200 gap-1"
			style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);"
		>
			<X class="size-5" />
			Close
		</button>
	</div>

	<script>
		const search = document.getElementById("search_games");
		const games = document.getElementById("games");
		const cards = Array.from(games.querySelectorAll(".game-card"));
		const openGames = new Map();

		search.addEventListener("input", (e) => {
			const q = e.target.value.toLowerCase();
			cards.forEach((card) => {
				const match = card.getAttribute("data-title").toLowerCase().includes(q);
				card.style.display = match ? "inline-block" : "none";
			});
		});

		games.addEventListener("click", (e) => {
			const card = e.target.closest(".game-card");
			if (!card) return;
			const fn = card.dataset.file;
			const t = card.dataset.title;
			if (fn && t) window.opengame(fn, t, card.dataset.frame);
		});

		games.addEventListener("keydown", (e) => {
			if (e.key !== "Enter" && e.key !== " ") return;
			const card = e.target.closest(".game-card");
			if (!card) return;
			e.preventDefault();
			const fn = card.dataset.file;
			const t = card.dataset.title;
			if (fn && t) window.opengame(fn, t, card.dataset.frame);
		});

		document.getElementById("sidebar_search").addEventListener("input", (e) => {
			const q = e.target.value.toLowerCase();
			document
				.querySelectorAll("#opened_games .sidebar-game-item")
				.forEach((item) => {
					const t = (item.dataset.title || "").toLowerCase();
					item.style.display = t.includes(q) ? "flex" : "none";
				});
		});

		function updateSidebar() {
			const hint = document.getElementById("no_games_hint");
			const btn = document.getElementById("close_all_games");
			hint.style.display = openGames.size ? "none" : "block";
			btn.disabled = !openGames.size;
		}

		function hideFrames() {
			document
				.getElementById("game")
				.querySelectorAll("iframe")
				.forEach((f) => f.classList.add("hidden"));
		}

		function showGame(key) {
			const data = openGames.get(key);
			if (!data || !data.frame) return;

			hideFrames();
			const container = document.getElementById("game");
			container.classList.remove("hidden");
			data.frame.classList.remove("hidden");
			document.getElementById("title").textContent = data.title;
			document.body.style.overflow = "hidden";
			data.frame.focus();

			document.querySelectorAll(".sidebar-game-item").forEach((el) => {
				const isActive = el.id === `sidebar-${key}`;
				el.style.background = isActive ? "var(--bg-elevated)" : "var(--bg-card)";
				el.style.borderColor = isActive ? "var(--border-active)" : "var(--border-subtle)";
			});
		}

		function addToSidebar(key, title) {
			const list = document.getElementById("opened_games");
			const item = document.createElement("div");
			item.id = `sidebar-${key}`;
			item.dataset.title = title;
			item.className = "sidebar-game-item group flex items-center gap-2 px-3 py-2 cursor-pointer transition-all duration-200";
			item.style.cssText = "background: var(--bg-card); border: 1px solid var(--border-subtle);";

			const span = document.createElement("span");
			span.className = "flex-1 text-sm truncate";
			span.style.color = "var(--text-secondary)";
			span.textContent = title;

			const btn = document.createElement("button");
			btn.className = "opacity-0 group-hover:opacity-100 p-1 transition-opacity";
			btn.style.color = "var(--text-muted)";
			btn.innerHTML = `<svg class="size-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>`;
			btn.onclick = (e) => {
				e.stopPropagation();
				closeGame(key);
			};

			item.onclick = () => showGame(key);
			item.append(span, btn);
			list.appendChild(item);
		}

		function closeGame(key) {
			const data = openGames.get(key);
			if (data && data.frame) {
				data.frame.src = "about:blank";
				data.frame.remove();
			}
			document.getElementById(`sidebar-${key}`)?.remove();
			openGames.delete(key);
			updateSidebar();

			const container = document.getElementById("game");
			if (!container.querySelector("iframe")) {
				if (openGames.size) {
					showGame(openGames.keys().next().value);
				} else {
					container.classList.add("hidden");
					document.body.style.overflow = "";
				}
			}
		}

		window.opengame = async (file_name, title, frameGame) => {
			const key = file_name.replace(/[^a-zA-Z0-9]/g, "_");
			if (openGames.has(key)) {
				showGame(key);
				return;
			}

			hideFrames();
			const container = document.getElementById("game");
			const frame = document.createElement("iframe");
			frame.id = `frame-${key}`;
			frame.title = "game";

			openGames.set(key, { title, file_name, frameGame, frame });
			addToSidebar(key, title);
			updateSidebar();

			document.getElementById("title").textContent = title;
			container.classList.remove("hidden");
			document.body.style.overflow = "hidden";

			if (frameGame == "true") {
				frame.src = `https://raw.githack.com/hydra-network/asseting-bromine/main/${file_name}`;
			} else {
				frame.onload = async function () {
					if (this.dataset.loaded) return;
					const doc = this.contentDocument;
					const html = await fetch(
						`https://cdn.jsdelivr.net/gh/hydra-network/asseting-bromine@main/${file_name}`,
					).then((r) => r.text());

					doc.open();
					doc.write(html);
					doc.close();
					doc.querySelectorAll("script").forEach((s) => {
						const ns = doc.createElement("script");
						ns.src = s.src || "";
						if (!s.src) ns.textContent = s.textContent;
						s.replaceWith(ns);
					});
					this.dataset.loaded = "1";
				};
				frame.src = "/blank.html";
			}
			container.append(frame);
		};

		window.closegame = () => {
			hideFrames();
			document.getElementById("game").classList.add("hidden");
			document.body.style.overflow = "";
		};

		document.getElementById("back").addEventListener("click", closegame);
		document.getElementById("close_all_games").addEventListener("click", () => {
			[...openGames.keys()].forEach(closeGame);
		});
	</script>
</Layout>
